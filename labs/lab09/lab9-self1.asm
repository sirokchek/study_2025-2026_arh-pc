%include 'in_out.asm'

SECTION .data
    msg: DB 'Сумма f(x_i) = ', 0

SECTION .text
    GLOBAL _start

_start:
    ; ----------------------------------------------------
    ; Обработка аргументов командной строки
    ; ----------------------------------------------------
    pop ecx          ; Извлекаем количество аргументов
    pop edx          ; Извлекаем имя программы
    sub ecx, 1       ; Уменьшаем количество аргументов на 1 (убираем имя программы)
    mov esi, 0       ; Обнуляем сумму (будет хранить результат)

next:
    cmp ecx, 0       ; Проверяем, остались ли аргументы
    je _end          ; Если нет, переходим к выводу

    pop eax          ; Извлекаем следующий аргумент (x_i как строка)
    call atoi        ; Преобразуем строку в число (x_i в eax)
    
    ; ----------------------------------------------------
    ; ВЫЗОВ ПОДПРОГРАММЫ для вычисления f(x)
    ; ----------------------------------------------------
    call calc_f      ; Вызываем подпрограмму, x уже в eax
    
    add esi, eax     ; Добавляем f(x_i) к общей сумме
    
    dec ecx          ; Уменьшаем счётчик аргументов
    jmp next         ; Переходим к следующему аргументу

_end:
    ; ----------------------------------------------------
    ; Вывод результата
    ; ----------------------------------------------------
    mov eax, msg
    call sprint      ; "Сумма f(x_i) = "
    mov eax, esi
    call iprintLF    ; Вывод суммы
    call quit        ; Завершение программы

; ----------------------------------------------------
; ПОДПРОГРАММА calc_f
; Вычисляет f(x) = 15x - 9
; Вход:  x в eax
; Выход: f(x) в eax
; ----------------------------------------------------
calc_f:
    push ebx         ; Сохраняем ebx (будем использовать)
    mov ebx, 15      ; ebx = 15
    mul ebx          ; eax = 15 * x
    sub eax, 9       ; eax = 15x - 9
    pop ebx          ; Восстанавливаем ebx
    ret              ; Возврат в основную программу
